generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== 인증 관련 ====================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  role          String    @default("user")    // "user" | "admin"
  status        String    @default("pending") // "pending" | "active" | "inactive"
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  histories       History[]
  chatSessions    ChatSession[]
  preference      UserPreference?
  domainTerms     DomainTerm[]
  businessRules   BusinessRule[]
  frequentTables  FrequentTable[]
  promptFeedbacks PromptFeedback[]
}

// ==================== 맞춤형 프롬프트 설정 ====================

// 사용자 선호도
model UserPreference {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // SQL 스타일
  sqlKeywordCase      String   @default("uppercase")    // "uppercase" | "lowercase"
  aliasStyle          String   @default("meaningful")   // "short" | "meaningful"
  indentation         String   @default("2spaces")      // "2spaces" | "4spaces" | "tab"

  // 응답 스타일
  explanationDetail   String   @default("detailed")     // "brief" | "detailed"
  responseTone        String   @default("formal")       // "formal" | "casual"

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// 도메인 용어집
model DomainTerm {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  term        String   // 비즈니스 용어
  mapping     String   // DB 매핑
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, term])
  @@index([userId])
}

// 비즈니스 규칙
model BusinessRule {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name        String
  condition   String   // SQL 조건
  scope       String   @default("global")
  isActive    Boolean  @default(true)
  isLearned   Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

// ==================== 학습 시스템 ====================

// 자주 사용하는 테이블
model FrequentTable {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  tableName   String
  usageCount  Int      @default(1)
  lastUsedAt  DateTime @default(now())

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, tableName])
  @@index([userId])
}

// 사용자 피드백
model PromptFeedback {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  sessionId   String?
  messageId   String?
  feedback    String
  type        String   // "preference" | "correction" | "rule"
  isProcessed Boolean  @default(false)

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([isProcessed])
}

// 학습 로그
model LearningLog {
  id          String   @id @default(cuid())
  userId      String

  learnedAt   DateTime @default(now())
  summary     String   // JSON

  @@index([userId])
}

// ==================== 채팅 세션 관련 ====================

model ChatSession {
  id        String   @id @default(cuid())
  title     String?  // 첫 질문 기반 자동 생성
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  messages  ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([updatedAt])
}

model ChatMessage {
  id        String   @id @default(cuid())
  role      String   // "user" | "assistant"
  content   String   // 사용자 질문 또는 설명
  sql       String?  // 생성된 SQL (assistant만)

  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([sessionId])
}

// ==================== 히스토리 관련 ====================

model History {
  id        String      @id @default(cuid())
  type      String      // "documentation" | "query"
  input     String      // 사용자 입력 (코드 또는 자연어)
  output    String      // Claude 응답
  metadata  String?     // JSON 형태의 추가 정보

  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime    @default(now())

  @@index([userId, type])
  @@index([createdAt])
}
